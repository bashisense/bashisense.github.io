# 系统介绍

WalOS（Walnut + OS）是杭州八识科技有限公司开发的一款基于深度学习算法的边缘计算操作系统，主要用于人脸识别门禁产品、人脸识别考勤产品、人脸抓拍相机、车牌识别产品、点人数产品、非机动车识别产品与工业机器视觉产品等领域。集成ISP调节算法，图像处理算法、人脸检测算法、人脸特征提取算法、视频结构化算法、行为特征识别算法等人工智能算法，算法可适配多种硬件加速引擎，可接入八识智云平台，也可以提供本地API(基于HTTP/HTTPS协议)方便第三方集成。

## 1. 管理模式

1. **智云模式**：设备接入八识智云平台，用户通过小程序、安卓app访问八识智云平台，间接访问设备；
2. **私有模式**：设备接入第三方平台；
3. **本地模式**：设备不接入八识智云平台，提供HTTP API接口，第三方应用通过API接口管理使用设备；
4. **企业微信模式**：设备接入企业微信平台，通过企业微信的考勤、门禁功能使用设备；（后续版本提供）
5. **飞书模式**：设备接入飞书平台，通过飞书考勤、门禁功能使用设备；（后续版本提供）
6. **钉钉模式**：设备接入钉钉平台，通过钉钉考勤、门禁功能使用设备；（后续版本提供）

本文档主要说明智云模式与本地模式的协议接口，这两个协议在数据传输层面基本相同，只是数据传输底层协议不同，部分功能会有微小差异，在文档中会有标注说明。

## 2. 智云模式

此模式不对第三方开放接口

## 3. 私有模式

类似智云模式时，系统上电运行后，根据配置好的管理服务器地址，设备通过TCP协议主动连接云服务，主要过程如下：

1. 设备连接云端服务器：设备启动TCP客户端，连接云服务器；
2. 设备向云服务器发送INFO RSP数据；
3. 管理服务向设备发送登陆请求;
4. 设备向管理服务器发送响应；
5. 心跳数据：设备定时向服务器发送心跳数据包；
6. 事件上报：设备主动向服务器上报发生的事件；
7. 数据通信：服务器向设备发送请求，设备向服务器发送响应；

消息格式

序号|长度|名称|含义
---:|:---:|:---|:--
1|1|vers|消息版本号
2|1|type|消息体类型
3|2|sequence|消息序号，递增，可忽略，溢出后复零继续递增
4|4|length|消息体的长度，字节数，最长不超过1MB
5|8|session|会话ID，响应与请求一致，设备端不做解释
6|x|body|消息体，文本4字节对齐数据，JSON格式

## 4. 本地模式

本地模式时，采用HTTP API方式，向第三方提供访问接口，可根据配置，在事件发生时，向第三方发送事件请求，上报事件。基本的过程如下：

1. 采用扫描程序，发现局域网内设备，并获取设备ID号；也可以请求IP地址，通过info指令获取设备信息
2. 获取该ID对应设备的激活码：通过app方式或批量采购方式激活设备；出厂设备已激活
3. 通过HTTP API配置、管理设备；

## 4. 获取设备基本信息

#### 1. 智云模式

请求设备信息

#### 2. 私有模式

请求设备信息

#### 3. 本地模式

>请求URL: http://dev-ip-addr:port:/api/info
>请求类型: POST
>HTTP头：token = 可不填写
>请求消息体:JSON
>返回消息体:JSON, retcode = 0时正确， 非0时出错

1. 查询设备基本信息：

- 请求

```json
{
    "action": "info"
}
```

- 响应

```json
{
    "walos-version" : "v2.1.0",             // WalOS 操作系统版本号
    "algm-version"  : "v1.1.0",             // 算法版本号
    "hardware-version" : "v1.2.0",          // 硬件载体版本号
    "device-id" : "device-id",
    "retcode":0
}
```

#### 4. 错误码

1. 100 系统内存不足 
2. 101 参数出错 
3. 102 数据库操作失败 
4. 103 操作目标不存在
5. 104 无效人脸数据
6. 105 TOKEN不正确
7. 106 系统过载
8. 107 校验码出错
9. 108 快照出错
10. 109 文件操作失败

