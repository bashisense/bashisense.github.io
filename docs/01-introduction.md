# 系统介绍
---------

WalOS（Walnut OS）是杭州八识科技有限公司开发的基于深度学习算法的边缘计算嵌入式操作系统，主要用于集成有人脸识别、人脸抓拍、人形检测、非机动机检测、行为分析等AI算法的嵌入式产品，包括人脸识别门禁产品、考勤机产品；人脸抓拍、人形检测与跟踪等智能相机产品；车牌识别、非机动车检测等智能相机产品。

WalOS分为四个子系统，包括:

1. 前端图像处理子系统: 集成有ISP调节算法，图像处理算法等；
2. AI算法子系统，集成有人脸检测算法、人脸特征提取算法、人形检测算法、非机动机检测算法、车牌识别算法等视频结构化算法；
3. 控制子系统，集成外设控制，包括刷卡、雷达、二维友读头、人体测温等模块，并可控制继电器、RS485接口外设、韦根口门禁、梯控等；
4. 管理子系统，集成webapi服务，可对接八识智云平台、八识门禁控制器、企业微信以及大量第三方应用平台软件；


## 管理模式

WalOS可以配置为多种管理模式，用于对接不同的平台，主要模式有：

1. **智云模式**：设备接入八识智云平台，用户通过小程序、安卓app、PC客户端访问八识智云平台，间接访问设备；
2. **本地模式**：设备接入八识门禁控制器或PC客户端，通过安卓app、PC客户端访问设备；
3. **微信模式**：设备接入企业微信平台，通过企业微信的考勤、门禁功能使用设备；
4. **其它模式**：设备可提供websocket或http client端，接入第三方云平台，用户通过第三方云平台管理设备；
5. **独立模式**：设备不接入任何平台，仅提供HTTP API接口，第三方应用通过API接口管理使用设备（此模式一直要用）；

** 其中独立模式一直存在，可与 1/2/3/4四种方式并存，但1/2/3/4模式同一个时刻仅一种模式有效，不可并存 **

本文档主要说明其它模式与独立模式的协议内容，两者的协议内容基本一致，仅底层传输协议不同。

## 其它模式

设备运行于其它模式时，设备本身做为客户端(client),根据配置的manager-server系统，主动连接第三方服务端平台，包括有两协议:

1. HTTP/HTTPS协议：设备通过http/https协议请求服务端，上报心跳、事件（识别事件或运行告警事件）等，并根据心跳返回的任务列表请求任务，这些任务包括用户管理、配置管理、访客管理、规则管理、广告管理、门卡管理等。
2. websocket协议：设备通过websocket协议请求服务端，并建立长连接，上报心跳、事件（识别事件或运行告警事件）等，并根据服务端下发的请求，响应处理任务，这些任务包括用户管理、配置管理、访客管理、规则管理、广告管理、门卡管理等。

两者任务的内容一致，仅传输的协议不同。

典型的过程：
#### HTTP/HTTPS协议:
- 1. 设备通过向服务端发起连接，并注册设备到服务端；
- 2. 设备定时向服务端发送心跳数据，服务端响应心跳数据，如果有待推送任务，则在心跳响应包中设置任务类型；
- 3. 设备根据心跳响应中的任务，向服务端请求任务，处理任务，提交任务结果；
- 4. 设备向服务端提交运行告警事件、识别事件等；

典型的HTTP协议任务：
- 任务：服务器向设备响应心跳时带有的任务

```json
{
    "action": "pong",   // 设备发向服务器的心跳为 ping
    "task":{
        "object":"user",            // user, rule, visitor, card, advt ...
        "action":"insert"           // insert, remove, update, lookup, list
    }
}
```

- 请求， 设备向服务器发送请求

```json
{
    "object":"user",
    "action": "insert"
}
```

- 响应，服务器向设备发送响应

```json
{
    "object":"user",
    "action": "insert",
    "params": [
        {
            "userid": "1avsoHu2EeqZmH943F8eUg",
            "name": "李四",
            "desc": "研发部",
            "others": "17763548853",
            "rule": "Iksiwim",
            "effect": 159393303,
            "expire": 159703303,
        },
        {
            "userid": "1aw6wHu2EeqZmH943F8eUg",
            "name": "张三",
            "desc": "国际贸易部",
            "others": "18563548853",
            "rule": "Iksiwim",
            "effect": 159393303,
            "expire": 159703303,
        }
    ]
}
```

- 提交结果，设备向服务器提交结果

```json
{
    "retcode": 0,
    "params": [
        { 
            "userid":"1avsoHu2EeqZmH943F8eUg",
            "ops": 0
        },
        {
            "userid":"1aw6wHu2EeqZmH943F8eUg",
            "ops": 102
        }
    ]
}
```

####  websocket协议:
- 1. 设备通过向服务端发起连接，并注册设备到服务端；
- 2. 设备定时赂服务端发送心跳数据，服务端响应心跳数据；
- 3. 服务端向设备发送任务请求，设备处理请求并返回结果；
- 4. 设备向服务端提交运行告警事件、识别事件等；

典型的websocket协议消息体：
- 请求， 服务器向设备发送请求

```json
{
    "object":"info",
    "action": "info"
}
```

- 响应，设备向服务器发送响应

```json
{
    "walos-version" : "v2.1.0",             // WalOS 操作系统版本号
    "algm-version"  : "v1.1.0",             // 算法版本号
    "hardware-version" : "v1.2.0",          // 硬件载体版本号
    "device-id" : "device-id",
    "retcode":0
}
```

## 独立模式

独立模式在设备启动后一直运行，不受设备配置为其它模式时影响，但如果配置为独立模式，设备将向manager-server提交事件信息，独立模式不配置时，虽然可以通过HTTP API的方式访问设备，但设备并不向manager-server配置提交事件，仅此一项不同。

使用独立模式的典型过程：

1. 采用扫描程序，发现局域网内设备或通过固定IP地址连接设备，请登陆设备；
2. 向设备发送http请求，设备接收请求、处理任务并返回处理结果；
3. 如果设备配置为独立模式，则设备向manager-server提交运行告警事件、识别事件。

典型请求：

>请求URL: http://dev-ip-addr:port:/api/info
>请求类型: POST
>HTTP头：token = 登陆前获取info信息可不填写，其它必须填写登陆时返回的token值
>请求消息体:JSON
>返回消息体:JSON, retcode = 0时正确， 非0时出错

例:查询设备基本信息：

- 请求

```json
{
    "action": "info"
}
```

- 响应

```json
{
    "walos-version" : "v2.1.0",             // WalOS 操作系统版本号
    "algm-version"  : "v1.1.0",             // 算法版本号
    "hardware-version" : "v1.2.0",          // 硬件载体版本号
    "device-id" : "device-id",
    "retcode":0
}
```

## 行文约定

本文后续部分，主要为请求-响应的数据包格式，直接对应到其它模式中的websocket的请求-响应，独立模式的请求-响应，以及其它模式的获取任务的响应信息-结果提交部分，这三个部分的内容基本上是一致的，仅仅是因为模式不同，与传输有关的地方有差异而已。 


